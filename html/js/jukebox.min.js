(function(){function e(a,n){if(!a||!n){var s="Notification: Invalid parameters (level, message)";throw new e(t.error,s),Error(s)}this.level=a,this.message=n;var l=8;this.id=(new Date).getTime()+"."+Math.round(1e5*Math.random());var o="notification-wrapper-";switch(a){case t.debug:o+="debug",l=3;break;case t.info:o+="info",l=4;break;case t.warning:o+="warning",l=4;break;case t.error:o+="error",l=20;break;case t.fatal:o+="fatal",l=20;break;default:o+="default"}i.push(this);var r='<div class="notification-wrapper" id="notification-'+this.id+'">'+'<div class="'+o+'" id="notification-content-'+this.id+'">'+"<p>"+n+" </p>"+"</div>"+"</div>";$("notifications").insert(r),this.startTime=new Date,this.endTime=null,$("notification-"+this.id).hide();var u=this;Effect.SlideDown("notification-"+this.id,{duration:.6,restoreAfterFinish:!1,afterFinish:function(e){Event.observe(e.element,"click",function(){u.remove()})}}),this._timer=setTimeout(function(){u.remove()},1e3*l),Object.seal(this)}var t={debug:1,info:2,warning:3,error:4,fatal:5};Object.freeze(t);var i=[],a=[];e.prototype.remove=function(){if(this._timer){var e=this;Effect.SlideUp("notification-"+this.id,{duration:.4,afterFinish:function(t){t.element.remove(),e.endTime=new Date;for(var n=0;i.length>n;n++)if(i[n]==e){i.splice(n,1),Object.freeze(e),a.push(e);break}}}),clearTimeout(this._timer),this._timer=null}},this.Notifications={LEVELS:t,history:a,Display:function(t,i){new e(t,i)}},Object.freeze(this.Notifications)})(),function(){function e(t){var i=!1,a=1;"boolean"==typeof t&&(i=t,t=arguments[1]||{},a=2),"object"!=typeof t&&"function"!=typeof t&&(t={});for(var n=arguments.length;n>a;++a){var s=arguments[a];if(null!=s)for(var l in s){var o=t[l],r=s[l];if(t!==r)if(i&&r&&(Object.isArray(r)||"object"==typeof r)){var u=o&&(Object.isArray(o)||"object"==typeof o)?o:Object.isArray(r)?[]:{};t[l]=e(i,u,r)}else void 0!==r&&s.hasOwnProperty(l)&&(t[l]=r)}}return t}function t(e){var t=null;if(e=Number(e),!isNaN(e)){var i=Math.floor(e/3600),a=Math.floor(e%3600/60),n=Math.floor(e%3600%60);t=(i>0?i+":":"")+(a>0?(i>0&&10>a?"0":"")+a+":":"0:")+(10>n?"0":"")+n}return t}function i(e){e=e.sort(function(e,t){return 1*e-1*t});for(var t=[e[0]],i=1;e.length>i;i++)e[i-1]!==e[i]&&t.push(e[i]);return t}function a(e){var t=JSON.stringify(e,null,"	");return t=t.replace(/\n/g,"<br />"),t=t.replace(/\t/g,"&nbsp;&nbsp;&nbsp;")}function n(t,i){if(!(this instanceof arguments.callee))return new n(t,i);switch(this.name=t,t){case"join_channel":this.channel=i.channel;break;case"next":case"previous":case"shuffle_play_queue":case"get_uploaded_files":break;case"add_to_play_queue":case"remove_from_play_queue":this.mid=i.mid,this.play_queue_index=i.play_queue_index;break;case"move_in_play_queue":this.mid=i.mid,this.play_queue_index=i.play_queue_index,this.new_play_queue_index=i.new_play_queue_index;break;case"get_news":this.first_result=i.first_result,this.result_count=i.result_count;break;case"select_plugin":this.channel=i.channel,this.plugin_name=i.plugin_name;break;case"search":case"update_uploaded_file":case"add_search_to_play_queue":e(this,i);break;case"delete_uploaded_file":case"validate_uploaded_file":this.file_name=i.file_name;break;default:throw Error("Invalid action")}Object.seal(this)}function s(e,t){if(!(this instanceof arguments.callee))return new s(e,t);if(this.lastTimestamp=e,this.actions=[],this.search=null,t)for(var i=0;t.length>i;++i)t[i]instanceof n&&this.actions.push(t[i]);Object.seal(this)}function l(e,t,i){this.name=e,this.uploadedFiles=t,this.uploadedFilesEdition=i}function o(t,i){function a(e){D.addAction(e),l()}function l(){if(R.activity(!0),F!==!1)return D.actions.length>0&&(q.push(D),D=new s),void 0;null!=O&&(clearTimeout(O),O=null),F=!0;var e=D;D=new s,u(e)}function u(e){e.setTimestamp(C);try{R.sendingQuery(e.valueOf())}catch(t){}var i=e.toJSON();new Ajax.Request(y.URL,{method:"POST",postBody:i,onSuccess:x.querySuccess,onFailure:x.queryFailure,onComplete:x.queryComplete})}function d(t){if(t.timestamp&&(C=t.timestamp),t.current_song&&(k=t.current_song,_.song=e(!0,{},k),_.lastServerResponse=new Date,R.updateCurrentSong(k),R.updateSongTime(k,_.lastServerResponse.getTime()/1e3)),t.channel_infos){w=t.channel_infos,_.channel=w.name;var i,a="";N>t.channel_infos.listener_count?(i=N-t.channel_infos.listener_count,a=i+" user"+(i>1?"s":"")+" left the channel",Notifications.Display(Notifications.LEVELS.debug,a)):t.channel_infos.listener_count>N&&(i=t.channel_infos.listener_count-N,a=i+" user"+(i>1?"s":"")+" join the channel",Notifications.Display(Notifications.LEVELS.debug,a)),_.listenersCount=N=t.channel_infos.listener_count,R.updateNbUsers(N)}if(t.play_queue){S=t.play_queue.songs;var n=e(!0,[],S);R.displayPlayQueue(n,N)}t.search_results&&R.displaySearchResults(t.search_results),t.messages&&t.messages.each(function(e){Notifications.Display(e.level,e.message)}),t.uploaded_files&&(A=t.uploaded_files,R.displayUploadedFiles(A))}function c(e,t){var i;if(Object.isArray(e)&&Object.isArray(t))for(var a=0,s=Math.min(e.length,t.length);s>a;a++)i=new n("add_to_play_queue",{mid:e[a],play_queue_index:t[a]}),D.addAction(i);else i=new n("add_to_play_queue",{mid:e,play_queue_index:t}),D.addAction(i);l()}function h(e,t){var i;if(0===arguments.length)for(var a=S.length-1;a>=0;--a)i=new n("remove_from_play_queue",{mid:a,play_queue_index:a}),D.addAction(i);else if(Object.isArray(e)&&Object.isArray(t))for(var s=0,o=Math.min(e.length,t.length);o>s;++s)i=new n("remove_from_play_queue",{mid:e[s],play_queue_index:t[s]}),D.addAction(i);else i=new n("remove_from_play_queue",{mid:e,play_queue_index:t}),D.addAction(i);l()}function m(e,t,i,s,l,o,r){var u={play_queue_position:e,select_fields:"mid",search_value:t,search_comparison:i,search_field:s,order_by:l,first_result:0,result_count:null};"like"==i&&(u.first_result=o,u.result_count=r),a(new n("add_search_to_play_queue",u))}function v(){"function"==typeof L&&L.call(_)}function g(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}}function b(e){var t=localStorage[e];if(t)try{t=JSON.parse(t)}catch(i){t=null}else t=null;return t}if(!(this instanceof arguments.callee))return new o(t,i);this.id="Jukebox"+ ++f,this.stream="",this.channel="",this.song=null,this.listenersCount=0,this.streaming=!1,this.playing=!1,this.lastServerResponse=null;var _=this,y=e(!0,{},o.defaults,i),C=0,w=null,S=[],k=null,E=null,T=100,N=0,D=new s(0),F=!1,O=null,q=[],A={},L=null,R=null;this.ready=function(e){if("function"!=typeof e){var t="Invalid parameter: .ready() needs a function";throw Notifications.Display(Notifications.LEVELS.error,t),Error(t)}return L=e,soundManager.enabled&&v(),this},this.autoRefresh=function(e){return y.autorefresh=!!e,y.autorefresh&&l(),this},this.refresh=function(){return C=0,l(),this},this.joinChannel=function(e){return a(new n("join_channel",{channel:e})),this},this.start=function(){return E.play(),this.streaming=!0,R.playing(this.playing=!0),this},this.stop=function(){return E.unload(),this.streaming=!1,R.playing(this.playing=!1),this},this.volume=function(e){if(arguments.length>0){if(e=Number(e),0>e||e>100){var t="Invalid volume level: "+e+" is not in 0-100 range";throw Notifications.Display(Notifications.LEVELS.error,t),Error(t)}E.setVolume(e),R.volume(e)}return T=E.volume},this.search=function(){var e=n.search.apply(0,arguments);return a(e),this},this.addToPlayQueue=function(e,t){return c(e,t),this},this.addToPlayQueueRandom=function(e){return c(e,Math.floor(Math.random()*S.length)),this},this.addToPlayQueueTop=function(e){return c(e,0),this},this.addToPlayQueueBottom=function(e){return c(e,S.length),this},this.playQueueShuffle=function(){return a(new n("shuffle_play_queue")),this},this.playQueueDelete=function(e,t){return 0===arguments.length?h():h(e,t),this},this.playQueueMove=function(e,t,i){return a(new n("move_in_play_queue",{mid:e,play_queue_index:t,new_play_queue_index:i})),this},this.playQueueSize=function(){return S.length},this.addSearchToPlayQueueRandom=function(e,t,i,a,n,s){return m("rand",e,t,i,a,n,s),this},this.addSearchToPlayQueueTop=function(e,t,i,a,n,s){return m("head",e,t,i,a,n,s),this},this.addSearchToPlayQueueBottom=function(e,t,i,a,n,s){return m("tail",e,t,i,a,n,s),this},this.savePlayQueue=function(e){if(g()){for(var t=b("playqueues")||{},i=[],a=0,n=S.length;n>a;++a)i[a]=S[a].mid;t[e]=i,localStorage.playqueues=JSON.stringify(t)}else Notifications.Display(Notifications.LEVELS.warning,"Cannot save playqueue: HTML5 storage not supported!");return this},this.restorePlayQueue=function(e,t){if(g()){var i=b("playqueues"),a=!1;if(null!==i){var n=i[e],s="head"==t?0:"rand"==t?Math.floor(Math.random()*S.length):S.length;n?c(n,$R(s,s+n.length).toArray()):a=!0}else a=!0;a&&Notifications.Display(Notifications.LEVELS.warning,"Unknown play queue in storage!")}return this},this.deletePlayQueue=function(e){if(g()){var t=b("playqueues");t&&(delete t[e],localStorage.playqueues=JSON.stringify(t))}return this},this.getPlayQueues=function(){var e=[];if(g()){var t=b("playqueues");if(t)for(var i in t)e.push(i)}return e},this.next=function(){return a(new n("next")),this},this.previous=function(){return a(new n("previous")),this},this.plugin=function(e){return a(new n("select_plugin",{channel:w.name,plugin_name:e})),this},this.getUploadedFiles=function(){return a(new n("get_uploaded_files")),this},this.uploadedFiles=function(){return A.files?A.files.slice():[]},this.deleteUploadedFile=function(e){return a(new n("delete_uploaded_file",{file_name:e})),this},this.validateUploadedFile=function(e){return a(new n("validate_uploaded_file",{file_name:e})),this},this.updateUploadedFile=function(e){return a(new n("update_uploaded_file",e)),this},p=function(e){D=e,l()};var x={querySuccess:function(e){return y.autorefresh&&(O=setTimeout(function(){l()},y.autorefresh_delay)),4==e.readyState&&0===e.status?(R.gotResponse(null),void 0):(R.gotResponse(e.responseText),d(e.responseJSON),void 0)},queryFailure:function(){R.gotResponse(null)},queryComplete:function(){if(F=!1,R.activity(!1),q.length>0){D.actions.length>0&&q.push(D);var e=q.splice(0,1)[0];D=e,l()}}};(function(){Object.seal(_),soundManager.setup({url:y.SM2Folder,flashVersion:9,useFlashBlock:!0,debugMode:!1,useHTML5Audio:!0,preferFlash:!1,onready:function(){var e=0,t=new Date;(function i(a){E=soundManager.createSound({id:_.id,url:y.streamURL+"?t="+(new Date).getTime(),autoPlay:a,onbufferchange:function(){e++,e>2&&setTimeout(function(){e=0;var t=E.volume;E.destruct(),i(!0),E.setVolume(t)},0);var a=new Date;a.getTime()-t.getTime()>2e3&&(e=0,t=a)}})})(!1),Notifications.Display(Notifications.LEVELS.debug,"Using "+(E.isHTML5?"HTML5":"flash")+" audio player"),v()},ontimeout:function(){var e="SM2 could not start";throw Notifications.Display(Notifications.LEVELS.error,e),Error(e)}}),R=new r(_,t,{replaceTitle:y.replaceTitle,skin:y.skin,theme:y.theme}),y.autorefresh&&l()})()}function r(i,a,n){function s(){m.expand_button.hide(),m.collapse_button.show(),m.jukebox.addClassName(g.rootClass+"-fullplayer")}function l(){m.expand_button.show(),m.collapse_button.hide(),m.jukebox.removeClassName(g.rootClass+"-fullplayer")}function o(e,t,i,a,n,s,l,o,r){s||(s=m.search_field.value),a||(a="genre"!=s?m.search_input.value:m.search_genres.value),o||(o=m.results_per_page.value),b.search(e,t,i,a,n,s,l,o,r)}function u(e,t){o(1,null,null,e,"equal",t,"artist,album,track,title",null,!1)}function c(){m.play_queue_content.select("."+g.rootClass+"-playqueue-droppable").each(function(e){Droppables.remove(e)})}function h(e,t){for(var i=e.className.split(" "),a=t?g.rootClass+"-playqueue-":g.rootClass+"-playqueue-song-",n=null,s=0;i.length>s;++s)if(-1!=i[s].indexOf(a)){n=i[s].substring(a.length);break}return n}function p(e,t){Droppables.add(e,{accept:[g.rootClass+"-playqueue-draggable","library-draggable"],overlap:"vertical",hoverclass:g.rootClass+"-droppable-hover",onDrop:function(e,i){var a,n;if(e.hasClassName(g.rootClass+"-playqueue-draggable")){var s=h(e);a=parseInt(s,10),n=e.up().retrieve("mid");var l=-1;if(!i.hasClassName(g.rootClass+"-playqueue-first")){var o=h(i,!0);l=parseInt(o,10)}if(a>=l&&l++,l!=a){b.playQueueMove(n,a,l),c();var r=t[a];t.splice(a,1),t.splice(l,0,r),v.displayPlayQueue(t)}}else if(e.hasClassName("library-draggable")){var u=RegExp(".*-([^\\-]*-[^\\-]*)-([0-9]*)"),d=e.id.replace(u,"$1");a=parseInt(e.id.replace(u,"$2"),10);var p=_.getTabFromUniqueId(d).server_results[a];n=p.mid;var f=-1;if(!i.hasClassName(g.rootClass+"-playqueue-first")){var m=h(i,!0);f=parseInt(m,10)}f++,b.addToPlayQueue(n,f),t.splice(f,0,p),v.displayPlayQueue(t)}}})}if(!(this instanceof arguments.callee))return new r(a,n);this.skin=r.defaults.skin,this.theme="";var f,m,v=this,g=e(!0,{},r.defaults,n),b=i,_=null,y=r.skins[g.skin],C=null,w=null;y?this.skin=g.skin:(g.skin=r.defaults.skin,y=r.skins[g.skin]),y.params=e(!0,{},r.defaults.skinParams,y.params),g.theme=-1==(y.themes||[]).indexOf(g.theme)?y.defaultTheme:g.theme,this.theme=g.theme,g.rootClass+=g.skin==r.defaults.skin?"":"-"+g.skin,this.activity=function(e){var t=g.rootClass+"-activity-on",i=g.rootClass+"-activity-off",a=i,n=t;e===!0&&(a=t,n=i),m.activity_monitor.removeClassName(n),m.activity_monitor.addClassName(a)},this.volume=function(e){f.setValue(e)},this.updateSongTime=function(e,i){C&&clearTimeout(C);var a=100;if(e){var n=e.elapsed+(new Date).getTime()/1e3-i;if(a=1e3*(Math.ceil(n)-n),n>e.duration&&(n=e.duration),null===w||n>w){var s=Math.round(100*(n/e.duration));m.progressbar.setStyle({width:s+"%"}),m.player_song_time.update(t(n)+"/"+t(e.duration))}w=n}else w=null,m.progressbar.setStyle({width:0}),m.player_song_time.update("--- / ---");C=setTimeout(function(){v.updateSongTime(e,i)},a+1)},this.updateCurrentSong=function(e){e&&(m.player_song_artist.update(e.artist).stopObserving().on("click",function(){u(e.artist,"artist")}),m.player_song_album.update(e.album).stopObserving().on("click",function(){u(e.album,"album")}),m.player_song_title.update(e.title),g.replaceTitle&&(document.title="Jukebox - "+e.artist+" - "+e.album+" - "+e.title))},this.updateNbUsers=function(e){var t=m.jukebox.select("."+g.rootClass+"-listening-count");t.each(function(t){t.update(""+e)})},this.playing=function(e){e?(m.play_stream.hide(),m.stop_stream.style.display="inline"):(m.play_stream.show(),m.stop_stream.hide())},this.displayPlayQueue=function(e){function i(e){var t=h(e.element);null!==t&&l.down(r+"playqueue-"+t).addClassName(g.rootClass+"-being-dragged")}function a(e){var t=h(e.element);null!==t&&l.down(r+"playqueue-"+t).removeClassName(g.rootClass+"-being-dragged")}c();var n=new Template(y.templates.playQueue),s={root:g.rootClass,playQueueLabel:"Play queue",listenersCount:b.listenersCount},l=new Element(y.params.playQueueNode).insert(n.evaluate(s)),r="."+g.rootClass+"-",u=l.down(r+"playqueue-shuffle"),d=l.down(r+"playqueue-delete");u&&u.on("click",function(){b.playQueueShuffle()}),d&&d.on("click",function(){b.playQueueDelete()});var f=0,v=e.length-1;e.each(function(e){var i=new Template(y.templates.playQueueSong),a={root:g.rootClass,index:f,artist:e.artist,album:e.album,title:e.title,duration:t(e.duration)};l.insert(i.evaluate(a));var n=l.down(y.params.songNode+":last");n.store("mid",e.mid);var s=n.down(r+"playqueue-handle a:first");s&&s.on("click",function(){o(1,null,null,e.artist,"equal","artist","artist,album,track,title",20,!1)});var u=n.down(r+"playqueue-handle a:last");u&&u.on("click",function(){o(1,null,null,e.album,"equal","album","artist,album,track,title",20,!1)});var c=f,h=n.down(r+"playqueue-move-top"),p=n.down(r+"playqueue-move-bottom");h&&h.on("click",function(){b.playQueueMove(1,c,0)}),p&&p.on("click",function(){b.playQueueMove(1,c,v)}),d=n.down(r+"playqueue-delete"),d&&d.on("click",function(){b.playQueueDelete(1,c)}),f++}),"TBODY"==l.nodeName&&(l=l.wrap("table")),m.play_queue_content.update(l);for(var _=0,C=e.length;C>_;_++){var w=l.down(r+"playqueue-"+_),S=w.down(r+"playqueue-song-"+_),k=S.down(r+"playqueue-handle-"+_);new Draggable(S,{scroll:window,constraint:"vertical",revert:!0,handle:k,onStart:i,onEnd:a}),p(w,e)}p(l.down(r+"playqueue-first"),e)},this.displaySearchResults=function(e){if(s(),e.identifier)_.getTabFromUniqueId(e.identifier).updateNewSearchInformations(e),_.getTabFromUniqueId(e.identifier).updateContent();else{var t=new SearchTab(b,m.tabs,e,g.rootClass),i=_.addTab(t);e.select!==!1&&_.toggleTab(i)}},this.sendingQuery=function(e){var t=_.getFirstTabByClass(DebugTab);t&&t.updateSendingQuery(e)},this.gotResponse=function(e){var t=_.getFirstTabByClass(DebugTab);t&&t.updateResponse(e)},this.displayUploadedFiles=function(e){var t=_.getFirstTabByClass(UploadTab);t&&t.treatResponse(e)},this.theme=function(e){if(arguments.length>0){var t=g.rootClass+"-theme-";m.jukebox.removeClassName(t+g.theme),g.theme=e,m.jukebox.addClassName(t+g.theme),this.theme=g.theme}return g.theme};var S={expand:function(){s()},collapse:function(){l()},joinChannel:function(){b.joinChannel(m.channel.value)},previousSong:function(){b.previous()},nextSong:function(){b.next()},playStream:function(){b.start()},stopStream:function(){b.stop()},volume:function(e){b.volume()!=e&&b.volume(e)},search:function(){o()},searchInputKeyPress:function(e){e.keyCode==Event.KEY_RETURN&&(o(),Event.stop(e))},selectAndFillGenres:function(){if("genre"==m.search_field.options[m.search_field.selectedIndex].value){if(0===m.search_genres.options.length)for(var e=0,t=d.length;t>e;++e){var i=d[e],a=document.createElement("option");a.value=i.id,a.appendChild(document.createTextNode(i.name)),m.search_genres.appendChild(a)}m.search_input.hide(),m.search_genres.show()}else m.search_input.show(),m.search_genres.hide()},autoRefreshChange:function(){b.autoRefresh(m.cb_autorefresh.getValue())},refresh:function(){b.refresh()},plugin:function(){b.plugin(m.selection_plugin.value)}};(function(){Object.seal(v);var e=$(a);try{var t=new Template(y.templates.song),i={root:g.rootClass},n=new Template(y.templates.player),s={root:g.rootClass,theme:g.theme,currentSong:t.evaluate(i),canalLabel:"Canal :",canalValue:"Rejoindre",searchLabel:"Rechercher :",searchButton:"Rechercher",UploadTabName:"Upload",QueryTabName:"Query",NotificationsTabName:"Notifications",DebugTabName:"Debug",PlaylistTabName:"Playlists",artist:"artiste",title:"title",album:"album",genre:"genre",refreshButton:"Refresh",refreshLabel:"Autorefresh",pluginLabel:"Plugin :",pluginDefault:"default",pluginButton:"Appliquer",play:"Play stream",stop:"Stop stream",volume:"Volume :",listenersCount:b.listenersCount};e.insert(n.evaluate(s))}catch(l){var o="Invalid skin: "+l.message;throw Notifications.Display(Notifications.LEVELS.error,o),Error(o)}var r="."+g.rootClass+"-",u=e.down("."+g.rootClass);m={jukebox:u,tabs:u.down(r+"tabs"),expand_button:u.down(r+"expand-button"),collapse_button:u.down(r+"collapse-button"),search_input:u.down(r+"search-input"),search_field:u.down(r+"search-field"),search_genres:u.down(r+"search-genres"),results_per_page:u.down(r+"results-per-page"),btn_search:u.down(r+"search-button"),progressbar:u.down(r+"progressbar"),player_song_time:u.down(r+"song-time"),activity_monitor:u.down(r+"activity"),play_stream:u.down(r+"stream-play"),stop_stream:u.down(r+"stream-stop"),channel:u.down(r+"channel"),btn_join_channel:u.down(r+"channel-button"),previous_button:u.down(r+"previous-button"),next_button:u.down(r+"next-button"),cb_autorefresh:u.down(r+"autorefresh"),btn_refresh:u.down(r+"refresh-button"),player_song_artist:u.down(r+"song-artist"),player_song_album:u.down(r+"song-album"),player_song_title:u.down(r+"song-title"),play_queue_content:u.down(r+"playqueue-content"),selection_plugin:u.down(r+"plugin"),btn_apply_plugin:u.down(r+"plugin-button"),volume_box_slider:u.down(r+"volume-slider"),tabs_links:u.down(r+"tabs-links")},m.collapse_button.hide(),m.stop_stream.hide();var d=new Element("p");for(var c in m)m[c]||(m[c]=d);_=new Tabs(g.rootClass),_.setRootNode(m.tabs),m.expand_button.on("click",S.expand),m.collapse_button.on("click",S.collapse),m.play_stream.on("click",S.playStream),m.stop_stream.on("click",S.stopStream),m.btn_join_channel.on("click",S.joinChannel),m.btn_search.on("click",S.search),m.search_field.on("change",S.selectAndFillGenres),m.search_input.observe("keypress",S.searchInputKeyPress),m.previous_button.on("click",S.previousSong),m.next_button.on("click",S.nextSong),m.cb_autorefresh.on("change",S.autoRefreshChange),m.btn_refresh.on("click",S.refresh),m.btn_apply_plugin.on("click",S.plugin);var h=$R(0,100);f=new Control.Slider(m.volume_box_slider.down(r+"volume-handle"),m.volume_box_slider,{range:h,values:h,sliderValue:100,onSlide:S.volume,onChange:S.volume}),function(){function e(e){t["Show"+e.classN]=function(){var t=_.getFirstTabByClass(e.classC);if(null===t){var i=new e.classC(e.name,m.tabs,g.rootClass,b);t=_.addTab(i)}_.toggleTab(t)}}for(var t={},i=[{classN:"UploadTab",classC:UploadTab,name:"Uploader"},{classN:"DebugTab",classC:DebugTab,name:"Debug"},{classN:"NotificationTab",classC:NotificationTab,name:"Notifications"},{classN:"CustomQueriesTab",classC:CustomQueriesTab,name:"Custom queries"},{classN:"PlaylistTab",classC:PlaylistTab,name:"Playlists"}],a=0;i.length>a;++a)e(i[a]);var n=m.tabs_links;n.empty()||(n.down(r+"tab-upload").on("click",t.ShowUploadTab),n.down(r+"tab-query").on("click",t.ShowCustomQueriesTab),n.down(r+"tab-notifs").on("click",t.ShowNotificationTab),n.down(r+"tab-debug").on("click",t.ShowDebugTab),n.down(r+"tab-playlist").on("click",t.ShowPlaylistTab))}()})()}var u={0:"Blues",1:"Classic Rock",2:"Country",3:"Dance",4:"Disco",5:"Funk",6:"Grunge",7:"Hip-Hop",8:"Jazz",9:"Metal",10:"New Age",11:"Oldies",12:"Other",13:"Pop",14:"R&B",15:"Rap",16:"Reggae",17:"Rock",18:"Techno",19:"Industrial",20:"Alternative",21:"Ska",22:"Death Metal",23:"Pranks",24:"Soundtrack",25:"Euro-Techno",26:"Ambient",27:"Trip-Hop",28:"Vocal",29:"Jazz+Funk",30:"Fusion",31:"Trance",32:"Classical",33:"Instrumental",34:"Acid",35:"House",36:"Game",37:"Sound Clip",38:"Gospel",39:"Noise",40:"Alternative Rock",41:"Bass",43:"Punk",44:"Space",45:"Meditative",46:"Instrumental Pop",47:"Instrumental Rock",48:"Ethnic",49:"Gothic",50:"Darkwave",51:"Techno-Industrial",52:"Electronic",53:"Pop-Folk",54:"Eurodance",55:"Dream",56:"Southern Rock",57:"Comedy",58:"Cult",59:"Gangsta",60:"Top 40",61:"Christian Rap",62:"Pop/Funk",63:"Jungle",64:"Native US",65:"Cabaret",66:"New Wave",67:"Psychadelic",68:"Rave",69:"Showtunes",70:"Trailer",71:"Lo-Fi",72:"Tribal",73:"Acid Punk",74:"Acid Jazz",75:"Polka",76:"Retro",77:"Musical",78:"Rock & Roll",79:"Hard Rock",80:"Folk",81:"Folk-Rock",82:"National Folk",83:"Swing",84:"Fast Fusion",85:"Bebob",86:"Latin",87:"Revival",88:"Celtic",89:"Bluegrass",90:"Avantgarde",91:"Gothic Rock",92:"Progressive Rock",93:"Psychedelic Rock",94:"Symphonic Rock",95:"Slow Rock",96:"Big Band",97:"Chorus",98:"Easy Listening",99:"Humour",100:"Acoustic",101:"Speech",102:"Chanson",103:"Opera",104:"Chamber Music",105:"Sonata",106:"Symphony",107:"Booty Bass",108:"Primus",109:"Porn Groove",110:"Satire",111:"Slow Jam",112:"Club",113:"Tango",114:"Samba",115:"Folklore",116:"Ballad",117:"Power Ballad",118:"Rhytmic Soul",119:"Freestyle",120:"Duet",121:"Punk Rock",122:"Drum Solo",123:"Acapella",124:"Euro-House",125:"Dance Hall",126:"Goa",127:"Drum & Bass",128:"Club-House",129:"Hardcore",130:"Terror",131:"Indie",132:"BritPop",133:"Negerpunk",134:"Polsk Punk",135:"Beat",136:"Christian Gangsta",137:"Heavy Metal",138:"Black Metal",139:"Crossover",140:"Contemporary C",141:"Christian Rock",142:"Merengue",143:"Salsa",144:"Thrash Metal",145:"Anime",146:"JPop",147:"SynthPop"},d=[];for(var c in u)d.push({id:c,name:u[c]});d.sort(function(e,t){return e.name<t.name?-1:e.name>t.name?1:0});var h=this.Tab=Class.create({initialize:function(e,t,i,a){this.name=e,this.jukebox=t,this.DOM=i,this.rootCSS=a}});this.Tabs=Class.create({initialize:function(e){this.rootCSS=e,this.tabs=[],this.currentTabUniqueId=-1,this.lastUniqueId=null},getTabFromUniqueId:function(e){for(var t=0,i=this.tabs.length;i>t;++t)if(this.tabs[t].identifier==e)return this.tabs[t];return null},getTabIndexFromUniqueId:function(e){for(var t=0,i=this.tabs.length;i>t;++t)if(this.tabs[t].identifier==e)return t;return-1},getFirstTabByClass:function(e){for(var t=0;this.tabs.length>t;++t)if(this.tabs[t]instanceof e)return this.tabs[t];return null},setRootNode:function(e){this.DOM=e},addTab:function(e){for(var t=e.constructor;null!=t.superclass;)t=t.superclass;if(t!=h)throw Error("Invalid tab instance");null==this.lastUniqueId?this.lastUniqueId=0:this.lastUniqueId++;var i=e.identifier=this.lastUniqueId;this.tabs.push(e),1==this.tabs.length&&this.DOM.down("."+this.rootCSS+"-tabs-header").update('<ul class="'+this.rootCSS+'-tabs-list"></ul>');var a="javascript:;",n=new Element("a",{href:a}).update("<span>"+e.name+"</span>"),s=new Element("a",{href:a}).update("<span> X </span>"),l=this;n.on("click",function(){l.toggleTab(i)}),s.on("click",function(){l.removeTab(i)});var o=new Element("li",{"class":this.rootCSS+"-tabHeader-"+i}).insert({top:n,bottom:s});1==this.tabs.length&&o.addClassName(this.rootCSS+"-tabs-active");var r=new Element("div",{"class":this.rootCSS+"-tabContent-"+i});return this.tabs.length>1&&r.hide(),this.DOM.down("."+this.rootCSS+"-tabs-list").insert(o),this.DOM.down("."+this.rootCSS+"-tabs-content").insert(r),"function"==typeof e.updateContent&&e.updateContent(),i},removeTab:function(e){var t=this.getTabIndexFromUniqueId(e);if(-1!=t){var i=this.DOM.down("."+this.rootCSS+"-tabs-list").down("."+this.rootCSS+"-tabHeader-"+e),a=this.DOM.down("."+this.rootCSS+"-tabs-content").down("."+this.rootCSS+"-tabContent-"+e);i&&i.hasClassName(this.rootCSS+"-tabs-active")&&(0!==t?this.toggleTab(this.tabs[t-1].identifier):this.tabs.length>1&&this.toggleTab(this.tabs[t+1].identifier)),this.tabs.splice(t,1),i&&i.remove(),a&&a.remove()}},toggleTab:function(e){for(var t=0,i=this.tabs.length;i>t;++t){var a=this.tabs[t],n=a.identifier,s=this.DOM.down("."+this.rootCSS+"-tabs-list").down("."+this.rootCSS+"-tabHeader-"+n),l=this.DOM.down("."+this.rootCSS+"-tabs-content").down("."+this.rootCSS+"-tabContent-"+n);a.identifier==e?(l.show(),s.addClassName(this.rootCSS+"-tabs-active")):(l.hide(),s.removeClassName(this.rootCSS+"-tabs-active"))}}}),this.SearchTab=Class.create(h,{initialize:function($super,e,t,i,a){this.reloadControllers=!0,this.pages=[],this.sliders=[],this.tableKit=null;var n=i.identifier;$super(n,e,t,a),this.updateNewSearchInformations(i)},updateNewSearchInformations:function(e){var t=e.search_value,i=e.search_field;""===t?this.name="Library":"equal"==e.search_comparison?"artist"==i?this.name="Artist: "+t:"album"==i?this.name="Album: "+t:"genre"==i&&(this.name="Genre: "+u[t]):this.name=t,this.select_fields=e.select_fields,this.search_value=e.search_value,this.search_comparison=e.search_comparison,this.search_field=e.search_field,this.first_result=e.first_result,this.result_count=e.result_count,this.order_by=e.order_by,this.total_results=e.total_results,this.server_results=e.results,this.page_count=Math.floor(this.total_results/this.result_count),this.total_results%this.result_count>0&&(this.page_count=this.page_count+1),this.current_page=Math.floor(this.first_result/this.result_count)+1,this.current_page>this.page_count&&(this.current_page=1),this.locked=[]},goToPage:function(e){this.jukebox.search((e-1)*this.result_count,this.identifier,this.select_fields,this.search_value,this.search_comparison,this.search_field,this.order_by,this.result_count)},sort:function(e){this.jukebox.search(this.page,this.identifier,this.select_fields,this.search_value,this.search_comparison,this.search_field,e,this.result_count)},updateContent:function(){if(this.reloadControllers){this.DOM.select("collection-pagelist-"+this.identifier).each(function(e){e.remove()});var e=$("collection-content-"+this.identifier);e&&e.remove();var t='<div class="collection-pagelist" name="collection-pagelist-'+this.identifier+'"></div>'+'<div id="collection-content-'+this.identifier+'"></div>'+'<div class="collection-pagelist" name="collection-pagelist-'+this.identifier+'"></div>';this.DOM.down("."+this.rootCSS+"-tabContent-"+this.identifier).update(t),this.initAndDisplaySearchControllers(),this.reloadControllers=!1}else{this.generatePagesLinks();for(var i in this.sliders)"function"==typeof this.sliders[i].setValue&&(this.locked[i]=!0,this.sliders[i].setValue(this.current_page),this.locked[i]=!1)}this.initAndDisplaySearchResults()},initAndDisplaySearchControllers:function(){var e=this.identifier,t=$$("[name=collection-pagelist-"+e+"]");if(t.each(function(e){e.update()}),this.total_results>0&&this.page_count>1){var i=this.dom.getWidth(),a='<div name="results-slider-'+e+'" class="slider" style="width:'+i+'px;">'+'<div class="handle"></div>'+"</div>",n='<div class="page-links" name="page-links-'+e+'"></div>';t[0].update("<p>"+a+n+"</p>"),t[1].update("<p>"+n+a+"</p>")}for(var s=0;this.page_count>s;++s)this.pages.push(s+1);this.generatePagesLinks();var l=$$("[name=results-slider-"+e+"]"),o=this,r=0;l.each(function(e){var t=new Control.Slider(e.down(".handle"),e,{range:$R(1,o.pages.length),values:o.pages,sliderValue:o.current_page||1,id:r++,timeout:null,lastSelectedValue:null,onSlide:function(e){o.generatePagesLinks(e);for(var t=0;o.sliders>t;++t)t!=this.id&&(o.locked[t]=!0,"function"==typeof o.sliders[t].setValue&&o.sliders[t].setValue(e),o.locked[t]=!1);this.lastSelectedValue!=e&&(clearTimeout(this.timeout),this.timeout=setTimeout(function(){o.goToPage(e)},400)),this.lastSelectedValue=e},onChange:function(e){o.locked[this.id]||(clearTimeout(this.timeout),o.current_page!=e&&o.goToPage(e))}});t.handleLength=25,o.sliders.push(t)})},declareTableHeader:function(){function e(e,t,i){var a=new Element(r,{id:"duration"}).update(i),n="DESC";-1!=s.indexOf(e)&&(-1==s.indexOf(n)?a.className="sortcol sortasc":(a.className="sortcol sortdesc",n="ASC")),t=t.replace("${ORDER}",n),a.on("click",function(){u.sort(t)}),o.insert(a)}function t(){l.addSearchToPlayQueueRandom(u.search_value,u.search_comparison,u.search_field,u.order_by,u.first_result,u.result_count)}function i(){l.addSearchToPlayQueueTop(u.search_value,u.search_comparison,u.search_field,u.order_by,u.first_result,u.result_count)}function a(){l.addSearchToPlayQueueBottom(u.search_value,u.search_comparison,u.search_field,u.order_by,u.first_result,u.result_count)}var n,s=this.order_by.split(",")[0],l=this.jukebox,o=new Element("tr"),r="th",u=this;n="artist COLLATE NOCASE ${ORDER}, album COLLATE NOCASE DESC, track DESC, title COLLATE NOCASE DESC",e("artist",n,"Artist"),n="album COLLATE NOCASE ${ORDER}, track DESC, title COLLATE NOCASE DESC",e("album",n,"Album"),n="title COLLATE NOCASE ${ORDER}, artist COLLATE NOCASE DESC, album COLLATE NOCASE DESC, track DESC",e("title",n,"Title"),n="track ${ORDER}, artist COLLATE NOCASE DESC, album COLLATE NOCASE DESC, title COLLATE NOCASE DESC",e("track",n,"Track"),n="genre ${ORDER}, artist COLLATE NOCASE DESC, album COLLATE NOCASE DESC, track DESC, title COLLATE NOCASE DESC",e("genre",n,"Genre"),n="duration ${ORDER}, artist COLLATE NOCASE DESC, album COLLATE NOCASE DESC, track DESC, title COLLATE NOCASE DESC",e("duration",n,"Duration");var d="Add search to play queue [Full]";"like"==this.search_comparison&&(d="Add search to play queue [Current page]");var c=this.createControlsCell(r,t,i,a,d);return c.writeAttribute("id","actions"),o.insert(c),o},createControlsCell:function(e,t,i,a,n){var s=new Element(e),l=new Element("a").update('<span class="add-to-play-queue-rand"></span>'),o=new Element("a").update('<span class="add-to-play-queue-top"></span>'),r=new Element("a").update('<span class="add-to-play-queue-bottom"></span>');return n&&(l.writeAttribute("title",n+" [RANDOM]"),o.writeAttribute("title",n+" [TOP]"),r.writeAttribute("title",n+" [BOTTOM]")),s.insert(o).insert({top:l,bottom:r}),l.on("click",t),o.on("click",i),r.on("click",a),s},initAndDisplaySearchResults:function(){function e(e,t){d.search(1,null,null,""+e,"equal",t,"artist,album,track,title",l,!0)}function i(t,i,a){var n=new Element("a",{href:"javascript:void(0)"}).update(t);
return n.on("click",function(){e(i,a)}),n}var a,n,s=new Element("tbody"),l=this.result_count,o=$("collection-content-"+this.identifier),r=!0,d=this.jukebox;if(this.total_results>0){var c=this,h=this.identifier,p=0;this.server_results.each(function(e){function l(){d.addToPlayQueueRandom(e.mid)}function o(){d.addToPlayQueueTop(e.mid)}function f(){d.addToPlayQueueBottom(e.mid)}n=r?"rowodd":"roweven",r=!r;var m=i(e.artist,e.artist,"artist"),v=i(e.album,e.album,"album"),g=[new Element("td").insert(m),new Element("td").insert(v),new Element("td").update(e.title),new Element("td").update(e.track),new Element("td"),new Element("td").update(t(e.duration))];if(u[e.genre]){var b=i(u[e.genre],e.genre,"genre");g[4].insert(b)}var _=c.createControlsCell("td",l,o,f);g.push(_);var y=new Element("tr",{id:"library-song-"+h+"-"+p++}).addClassName("library-draggable "+n);for(a=0;g.length>a;++a)y.insert(g[a]);s.insert(y)});var f=(new Date).getTime(),m="results-filelist-"+this.identifier+"-"+f,v=new Element("table",{id:m}).addClassName("resizable").addClassName("search-table");v.insert(s).insert({top:new Element("thead").insert(this.declareTableHeader()),bottom:new Element("tfoot").insert(this.declareTableHeader())}),o.update(v),this.tableKit=new TableKit(m,{sortable:!1,editable:!1,trueResize:!0,keepWidth:!0})}else o.update("No results found");if(null!=this.server_results)for(a=0;this.server_results.length>a;a++)new Draggable("library-song-"+this.identifier+"-"+a,{scroll:window,ghosting:!0,revert:function(e){e.style.position="relative"}})},generatePagesLinks:function(e){function t(e,t){var i=new Element("a",{href:"javascript:void(0)"}).addClassName(t).update(e+" ");return i.on("click",function(){p.goToPage(e)}),i}var a,n,s=[],l=5,o=this.current_page,r=this.page_count;if(e===void 0&&(e=this.current_page),r>25)for(a=1,n=Math.ceil(l)+2;n>a;++a)a>0&&r>=a&&s.push(a);else for(a=1;r>=a;++a)s.push(a);var u=[];u[0]=o,s.push(e);for(var d=0;u.length>d;++d){var c=Math.ceil(l/2),h=c;for(a=u[d]-c;u[d]>a;++a)a>0&&r>=a&&(c--,s.push(a));for(s.push(u[d]),a=u[d]+1,n=u[d]+Math.ceil(l/2)+1;n>a;++a)a>0&&r>=a&&(h--,s.push(a));if(c>0)for(a=u[d]+Math.ceil(l/2),n=u[d]+Math.ceil(l);n>a;++a)a>0&&r>=a&&s.push(a);else if(h>0)for(a=u[d]-Math.ceil(l),n=u[d]+Math.ceil(l/2);n>a;++a)a>0&&r>=a&&s.push(a)}for(a=r-Math.ceil(l);r>=a;++a)a>0&&r>=a&&s.push(a);s=i(s);var p=this;$$("[name=page-links-"+this.identifier+"]").each(function(i){i.update();var n=null;for(a=0;s.length>a;++a){null!=n&&n!=s[a]-1&&i.insert(" ..... ");var l;l=s[a]==o?"slider-link-current-page":s[a]==e?"slider-link-current-selection":"slider-link";var r=t(s[a],l);i.insert(r),n=s[a]}})}}),this.UploadTab=Class.create(h,{initialize:function(e,t,i,a){this.name=e,this.uploader=null,this.uploadedFiles=null,this.uploadedFilesEdition=null,this.lastSendingDeletionIdentifier=null,this.lastSendingUpdateIdentifier=null,this.lastSendingValidationIdentifier=null,this.refresher=null,this.tableId=(new Date).getTime(),this.DOM=t,this.rootCSS=i,this.jukebox=a},deleteUploadedSong:function(e){if(null===this.lastSendingDeletionIdentifier){var t=unescape(e);this.lastSendingDeletionIdentifier=t,this.jukebox.deleteUploadedFile(t)}else Notifications.Display(3,"Please retry after the following song has been deleted: "+this.lastSendingDeletionIdentifier)},getUploadedFileEditionFromFilename:function(e){if(null===this.uploadedFilesEdition)return null;for(var t=0,i=this.uploadedFilesEdition.length;i>t;++t)if(this.uploadedFilesEdition[t].filename==e)return this.uploadedFilesEdition[t];return null},updateUploadedSong:function(e){if(null===this.lastSendingUpdateIdentifier){var t=unescape(e);this.lastSendingUpdateIdentifier=t;var i=this.getUploadedFileEditionFromFilename(t),a={file_name:t,title:i.title,album:i.album,artist:i.artist,year:i.year,track:i.track,genre:i.genre};this.jukebox.updateUploadedFile(a)}else Notifications.Display(3,"Please retry after the following song has been updated: "+this.lastSendingUpdateIdentifier)},validateUploadedSong:function(e){if(null===this.lastSendingValidationIdentifier){var t=unescape(e);this.lastSendingValidationIdentifier=t,this.jukebox.validateUploadedFile(t)}else Notifications.Display(3,"Please retry after the following song has been validated: "+this.lastSendingValidationIdentifier)},deletionResponse:function(e,t){var i=this.lastSendingDeletionIdentifier;if(this.lastSendingDeletionIdentifier=null,"success"==e){if(null!==i){for(var a=0,n=this.uploadedFiles.length;n>a;++a)if(this.uploadedFiles[a].filename==i){this.uploadedFiles.splice(a,1),this.uploadedFilesEdition.splice(a,1);break}$("upload-line-"+escape(i)).remove(),Notifications.Display(2,"Song "+i+" sucessfully deleted"),this.reinitTable()}}else"error"==e&&Notifications.Display(4,t)},updateResponse:function(e,t){if("success"==e){Notifications.Display(1,t);var i=escape(this.lastSendingUpdateIdentifier),a="upload-line-"+i,n=$(a);n.select('[class="modified"]').each(function(e){e.removeClassName("modified")}),n.select('[class="update"]').each(function(e){e.hide()}),n.select('[class="validate"]').each(function(e){e.show()})}else"error"==e&&Notifications.Display(4,t);this.lastSendingUpdateIdentifier=null},validationResponse:function(e,t){var i=this.lastSendingValidationIdentifier;if(this.lastSendingValidationIdentifier=null,"success"==e){if(Notifications.Display(1,t),null!==i){for(var a=0,n=this.uploadedFiles.length;n>a;++a)if(this.uploadedFiles[a].filename==i){this.uploadedFiles.splice(a,1),this.uploadedFilesEdition.splice(a,1);break}$("upload-line-"+escape(i)).remove(),this.reinitTable()}}else"error"==e&&Notifications.Display(4,t)},reinitTable:function(){var e=$("uploaded-files");if(0===e.down("tbody").childElementCount)e.update("No file uploaded yet."),this.uploadedFilesEdition=null,this.uploadedFiles=null;else{var t=(new Date).getTime();$("uploaded-filelist-"+this.tableId).id="uploaded-filelist-"+t,this.tableId=t,this.tableKit=new TableKit("uploaded-filelist-"+this.tableId,{sortable:!0,editable:!0,trueResize:!0,keepWidth:!0})}},treatResponse:function(e){if(e.action_response){var t=e.action_response,i=t["return"],a=t.message;switch(t.name){case"validate_uploaded_file":this.validationResponse(i,a);break;case"delete_uploaded_file":this.deletionResponse(i,a);break;case"update_uploaded_file":this.updateResponse(i,a)}}e.files&&this.displayUploadedFiles(e.files)},getUploadedFileHtml:function(e){var t='<td class="static">'+e.filename+"</td><td>";e.artist&&(t+=e.artist),t+="</td><td>",e.album&&(t+=e.album),t+="</td><td>",e.title&&(t+=e.title),t+="</td><td>"+e.year+"</td><td>";var i=(""+e.track).indexOf("/");t+=-1!=i?e.track.split("/")[0]:e.track,t+="</td><td>",t+=-1!=i?e.track.split("/")[1]:0,t+="</td><td>",u[e.genre]&&(t+=u[e.genre]),t+='</td><td class="static actions"><div><a href="javascript:void(0);">X</a></div><div class="update" style="display:none;"><a href="javascript:void(0);">&nbsp;Update&nbsp;</a></div><div class="validate"><a href="javascript:void(0);">&nbsp;Validate&nbsp;</a></div></td>';var a=escape(e.filename),n=new Element("tr",{id:"upload-line-"+a}).update(t),s=n.select("div"),l=this;return s[0].on("click",function(){l.deleteUploadedSong(a)}),s[1].on("click",function(){l.updateUploadedSong(a)}),s[2].on("click",function(){l.validateUploadedSong(a)}),n},displayUploadedFiles:function(e){var t,i,a,n,s=$("uploaded-files"),l=s.down("tbody"),o=this;if(clearTimeout(this.refresher),this.refresher=setTimeout(function(){o.getUploadedFiles()},5e3),null===this.uploadedFiles||null===l||0===l.childElementCount&&e.length>0)if(e.length>0){this.uploadedFiles=JSON.parse(JSON.stringify(e)),this.uploadedFilesEdition=JSON.parse(JSON.stringify(e));var r='<table id="uploaded-filelist-'+this.tableId+'" class="sortable resizable editable upload-table">',u='<tr><th>Filename</th><th class="artist">Artist</th><th class="album">Album</th><th class="title">Title</th><th class="year">Year</th><th class="track">Track</th><th class="trackNb">TrackNb</th><th class="genre">Genre</th><th>Actions</th></tr>';r+="<thead>"+u+"</thead><tfoot>"+u+"</tfoot></table>",s.update(r);var d=new Element("tbody");for(t=0;e.length>t;++t)d.insert(this.getUploadedFileHtml(e[t])),this.removeFileFromQQUpload(e[t].filename);s.down("table").insert(d),this.makeCellEditable("artist"),this.makeCellEditable("album"),this.makeCellEditable("title"),this.makeCellEditable("year"),this.makeCellEditable("track"),this.makeCellEditable("trackNb"),this.makeCellEditable("genre"),this.tableKit=new TableKit("uploaded-filelist-"+this.tableId,{sortable:!0,editable:!0,trueResize:!0,keepWidth:!0})}else s.update("No file uploaded yet.");else if(this.uploadedFiles.length>e.length){var c=[];for(i=0,a=this.uploadedFiles.length;a>i;++i){for(n=!1,t=0;e.length>t;++t)if(e[t].filename==this.uploadedFiles[i].filename){n=!0;break}n||c.push(this.uploadedFiles[i].filename)}for(t=0;c.length>t;++t){for(i=0,a=this.uploadedFiles.length;a>i;++i)if(this.uploadedFiles[t].filename==c[t].filename){this.uploadedFiles.splice(t,1),this.uploadedFilesEdition.splice(t,1);break}$("upload-line-"+escape(c[t])).remove()}}else if(this.uploadedFiles.length<e.length){var h=[];for(t=0,a=e.length;a>t;++t){for(n=!1,i=0;this.uploadedFiles.length>i;++i)if(e[t].filename==this.uploadedFiles[i].filename){n=!0;break}n||h.push(e[t])}for(t=0,a=h.length;a>t;++t)this.uploadedFiles.push(JSON.parse(JSON.stringify(h[t]))),this.uploadedFilesEdition.push(JSON.parse(JSON.stringify(h[t]))),$("uploaded-filelist-"+this.tableId).down("tbody").insert(this.getUploadedFileHtml(h[t])),this.removeFileFromQQUpload(h[t].filename);0!==this.uploadedFiles.length&&h.length>0&&this.reinitTable()}},makeCellEditable:function(e){var t=new l(e,this.uploadedFiles,this.uploadedFilesEdition);TableKit.Editable.addCellEditor(t)},removeFileFromQQUpload:function(e){$$(".qq-upload-success").each(function(t){t.down(".qq-upload-file").innerHTML==e&&(t.remove(),Notifications.Display(1,"Informations for "+e+"successfully retrieved."))})},getUploadedFiles:function(){this.jukebox.getUploadedFiles()},clear:function(){clearTimeout(this.refresher),this.refresher=null,this.uploader._handler._queue.length>0&&Notifications.Display(1,"All current uploads canceled."),this.uploader._handler.cancelAll()},updateContent:function(){var e='<div id="file-uploader'+this.identifier+'"></div>'+"<h2>Uploaded files</h2>"+'<div id="uploaded-files" style="overflow:auto;"></div>';this.DOM.down("."+this.rootCSS+"-tabContent-"+this.identifier).update(e),this.uploader=new qq.FileUploader({element:document.getElementById("file-uploader"+this.identifier),action:"upload",params:{id:this.identifier},debug:!0}),this.getUploadedFiles()}}),this.DebugTab=Class.create(h,{initialize:function(e,t,i){this.name=e,this.DOM=t,this.rootCSS=i},updateSendingQuery:function(e){this.$debug1.update("<h2>Data sent</h2><p>"+a(e)+"</p>"),this.$debug2.update("<h2>Waiting for response...</h2>")},updateResponse:function(e){e?this.$debug2.update("<h2>Data received:</h2><p> "+e+"</p>"+"<h2>JSON response: </h2>"+"<p>"+a(e.evalJSON())+"</p>"):this.$debug2.update('<img src="images/server_down.jpg" />')},updateContent:function(){var e='<h1>Debug console</h1><table width="100%"><tr><td width="50%"><div></div></td><td width="50%"><div></div></td></tr></table>',t=this.DOM.down("."+this.rootCSS+"-tabContent-"+this.identifier);t.update(e),this.$debug1=t.down("div:first"),this.$debug2=t.down("div:last")}}),this.PlaylistTab=Class.create(h,{initialize:function(e,t,i,a){this.name=e,this.DOM=t,this.rootCSS=i,this.jukebox=a},updateContent:function(){function e(e){var t=new Element("input",{type:"button",value:"Load"});return t.on("click",function(){n.restorePlayQueue(e)}),t}function t(e){var t=new Element("input",{type:"button",value:"Remove"});return t.on("click",function(){n.deletePlayQueue(e),a.updateContent()}),t}var i=this.DOM.down("."+this.rootCSS+"-tabContent-"+this.identifier);i.update("<h1>Playlists</h1>");for(var a=this,n=this.jukebox,s=n.getPlayQueues(),l=new Element("table").addClassName(this.rootCSS+"-playlists"),o=0,r=s.length;r>o;++o){var u=s[o],d=new Element("tr"),c=new Element("td").insert(u),h=new Element("td").insert(e(u)),p=new Element("td").insert(t(u));d.insert(h).insert({top:c,bottom:p}),l.insert(d)}i.insert(l);var f=new Element("input",{type:"button",value:"Save current playlist"});f.on("click",function(){for(var e="";""===e;)e=prompt("Name"),e&&(n.savePlayQueue(e),Notifications.Display(Notifications.LEVELS.info,"Current playlist save with name "+e),a.updateContent())}),i.insert(f)}}),this.CustomQueriesTab=Class.create(h,{initialize:function(e,t,i){this.name=e,this.DOM=t,this.rootCSS=i},updateContent:function(){var e='<h1>Custom Json Query</h1><table width="100%"><tr><td colspan="2"><center><textarea style="width:100%;height:160px;"></textarea></center></td></tr><tr><td>Query filler : <select><option value="clear_form">clear_form</option><option value="dummy" selected="selected">--------</option><option value="empty">empty</option><option value="next">next</option><option value="previous">previous</option><option value="add_to_play_queue">add_to_play_queue</option><option value="remove_from_play_queue">remove_from_play_queue</option><option value="move_in_play_queue">move_in_play_queue</option><option value="join_channel">join_channel</option><option value="get_news">get_news</option><option value="search">search</option></select></td><td><input type="button" value="send custom query"/></td></tr></table>',t=this.DOM.down("."+this.rootCSS+"-tabContent-"+this.identifier);t.update(e);var i,a,l=t.down("textarea"),o=t.down("select");o.on("change",function(){var e={},t=this.value;switch(t){case"dummy":return!1;case"clear_form":return l.value="",this.selectedIndex=1,!1;case"add_to_play_queue":case"remove_from_play_queue":case"move_in_play_queue":e={mid:123,play_queue_index:1};break;case"join_channel":e={channel:"trashman"};break;case"get_news":e={first_result:0,result_count:5};break;case"search":e={search_value:"muse",search_field:"artist",order_by:"artist",first_result:0,result_count:10}}return"move_in_play_queue"==t&&(e.new_play_queue_index=0),a="empty"==t?[]:[new n(t,e)],i=new s(1317675258,a),l.value=JSON.stringify(i.valueOf(),null,"	"),this.selectedIndex=1,!1});var r=t.down("input");r.on("click",function(){if(""===l.value)return Notifications.Display(Notifications.LEVELS.warning,"Please fill the textarea"),void 0;var e=JSON.parse(l.value);if(e&&e.action){i=new s(e.timestamp?e.timestamp:0),a=Object.isArray(e.action)?e.action:[e.action];for(var t=0;a.length>t;++t){var o=new n(a[t].name,a[t]);i.addAction(o)}p(i)}})}}),this.NotificationTab=Class.create(h,{initialize:function(e,t,i){this.name=e,this.uploader=null,this.DOM=t,this.rootCSS=i},updateContent:function(){function e(e){var i=new Element("input",{type:"button",value:"Test "+e});i.on("click",function(){Notifications.Display(Notifications.LEVELS[e],"Notification: "+e)}),t.insert(i)}var t=this.DOM.down("."+this.rootCSS+"-tabContent-"+this.identifier);t.update("<h1>Notification tests</h1>");for(var i in Notifications.LEVELS)e(i)}}),n.search=function(t,i,a,s,l,o,r,u,d){var c={identifier:i?i:null,select:!!d,search_value:s,search_comparison:l?l:"genre"!=o?"like":"equal",search_field:o,first_result:t&&1!=t?t:0,result_count:u};r&&(c.order_by=r),a&&(c.select_fields=a);var h=e({},n.search.defaultOptions,c);return new n("search",h)},n.search.defaultOptions={search_value:"",search_comparison:"like",search_field:"",order_by:"artist,album,track,title",select_fields:"mid,title,album,artist,track,genre,duration",first_result:0,result_count:20},s.prototype.addAction=function(e){if(!(e instanceof n))throw Error("Invalid action parameter");"search"==e.name?this.search=e:this.actions.push(e)},s.prototype.setTimestamp=function(e){this.lastTimestamp=e},s.prototype.removeAllActions=function(){this.actions=[]},s.prototype.toJSON=function(){return Object.toJSON(this.valueOf())},s.prototype.valueOf=function(){var e;return e=0===this.actions.length?{timestamp:this.lastTimestamp}:{timestamp:this.lastTimestamp,action:1==this.actions.length?this.actions[0]:this.actions},this.search&&(e.search=this.search),e},l.prototype._cancel=function(e){var t=Event.findElement(e,"td");Event.stop(e),this.cancel(t)},l.prototype.cancel=function(e){var t=TableKit.getCellData(e);e.innerHTML=t.htmlContent,t.htmlContent="",t.active=!1},l.prototype._undo=function(e){var t=Event.findElement(e,"td");Event.stop(e),this.undo(t)},l.prototype.undo=function(e){for(var t=e.up("tr"),i=t.id,a=0,n=this.uploadedFiles.length;n>a;++a){var s=escape(this.uploadedFiles[a].filename);if("upload-line-"+s==i){var l="upload-line-"+s,o=$(l);1==o.select('[class="modified"]').length&&(o.select('[class="update"]').each(function(e){e.hide()}),o.select('[class="validate"]').each(function(e){e.show()})),"track"==this.name?e.update(this.uploadedFiles[a].track.split("/")[0]):"trackNb"==this.name?e.update(this.uploadedFiles[a].track.split("/")[1]):e.update(this.uploadedFiles[a][this.name]),this.uploadedFilesEdition[a][this.name]=this.uploadedFiles[a][this.name];break}}e.removeClassName("modified");var r=TableKit.getCellData(e);r.active=!1},l.prototype._submit=function(e){var t=Event.findElement(e,"td"),i=Event.findElement(e,"form");Event.stop(e),this.submit(t,i)},l.prototype.submit=function(e,t){t=t?t:e.down("form");var i=e.up("tr"),a=i.id,n=t.firstChild,s=n.value;"genre"==this.name&&u[s]?e.update(u[s]):e.update(s);for(var l=0,o=this.uploadedFilesEdition.length;o>l;++l){var r=this.uploadedFilesEdition[l],d=escape(r.filename);if("upload-line-"+d==a){if("genre"==this.name?r[this.name]=n.options[n.selectedIndex].value:"track"==this.name?r[this.name]=-1==(""+r[this.name]).indexOf("/")?s+"/0":s+"/"+r[this.name].split("/")[1]:"trackNb"==this.name?r.track=-1==(""+r.track).indexOf("/")?r.track+"/"+s:(""+r.track).split("/")[0]+"/"+s:r[this.name]=s,("track"==this.name&&this.uploadedFiles[l][this.name].split("/")[0]!=s||"trackNb"==this.name&&this.uploadedFiles[l].track.split("/")[1]!=s||"track"!=this.name&&"trackNb"!=this.name&&s!=this.uploadedFiles[l][this.name])&&!e.hasClassName("modified")){e.addClassName("modified");var c=$("upload-line-"+d);c.select('[class="update"]').each(function(e){e.show()}),c.select('[class="validate"]').each(function(e){e.hide()})}else s==this.uploadedFiles[l][this.name]&&e.hasClassName("modified")&&e.removeClassName("modified");break}}var h=TableKit.getCellData(e);h.active=!1},l.prototype.edit=function(e){if(e=$(e),!e.hasClassName("static")){var t,i,a=e.up("table"),n=e.up("tr"),s=n.id,l=$(document.createElement("form"));l.id=e.id+"-form",l.addClassName(TableKit.option("formClassName",a.id)[0]),l.onsubmit=this._submit.bindAsEventListener(this);var o=!1;if("genre"==this.name){var r=document.createElement("select");for(r.id="genre",l.appendChild(r),i=0,t=d.length;t>i;++i){var u=d[i],c=document.createElement("option");c.value=u.id,c.appendChild(document.createTextNode(u.name)),r.appendChild(c)}for(i=0,t=this.uploadedFilesEdition.length;t>i;++i)"upload-line-"+escape(this.uploadedFilesEdition[i].filename)==s&&this.uploadedFilesEdition[i].genre!=this.uploadedFiles[i].genre&&(o=!0)}else{var h=document.createElement("input");for(h.type="text",i=0,t=this.uploadedFilesEdition.length;t>i;++i){var p=this.uploadedFilesEdition[i];if("upload-line-"+escape(p.filename)==s){"track"==this.name?-1==(""+p.track).indexOf("/")?h.value=p.track:(h.value=(""+p.track).split("/")[0],(""+p.track).split("/")[1]!=(""+this.uploadedFiles[i].track).split("/")[1]&&(o=!0)):"trackNb"==this.name?-1==(""+p.track).indexOf("/")?h.value="0":(h.value=(""+p.track).split("/")[1],(""+p.track).split("/")[1]!=(""+this.uploadedFiles[i].track).split("/")[1]&&(o=!0)):(h.value=p[this.name],p[this.name]!=this.uploadedFiles[i][this.name]&&(o=!0));break}}l.appendChild(h)}var f=document.createElement("input");if(f.type="submit",f.value="submit",f.className="editor-ok-button",l.appendChild(f),o){var m=document.createElement("a");m.href="#",m.appendChild(document.createTextNode("undo ")),m.onclick=this._undo.bindAsEventListener(this),m.className="editor-undo",l.appendChild(m),l.appendChild(document.createTextNode(" "))}var v=document.createElement("a");for(v.href="#",v.appendChild(document.createTextNode("cancel")),v.onclick=this._cancel.bindAsEventListener(this),v.className="editor-cancel",l.appendChild(v),e.innerHTML="",e.appendChild(l),i=0,t=this.uploadedFilesEdition.length;t>i;++i)if("upload-line-"+escape(this.uploadedFilesEdition[i].filename)==s){var g=$$("select#genre option"),b=g.length;b>0&&this.uploadedFilesEdition[i][this.name]>b&&(g[b-1].selected=!0);for(var _=0;b>_;_++)if(g[_].value==this.uploadedFilesEdition[i][this.name]){g[_].selected=!0;break}}}};var p,f=0,m={status:function(){var e=this.id+" is "+(this.streaming?"":"NOT ")+"connected to url "+this.stream+" and currently "+(this.playing?"":"NOT ")+"playing. Current channel is: "+this.channel+". "+this.listenersCount+" user"+(this.listenersCount>1?"s are":" is")+" currently listening. Current song is: "+this.song.title+" - "+this.song.artist+".";return e},remaining:function(){var e=0;if(this.song&&this.lastServerResponse instanceof Date){var t=((new Date).getTime()-this.lastServerResponse.getTime())/1e3;return Math.round(this.song.duration-this.song.elapsed-t)}return e}};e(o.prototype,m),o.defaults={URL:"/api/json",streamURL:"/stream",SM2Folder:"/",autorefresh:!0,autorefresh_delay:3e3,replaceTitle:!0},o.UI=r,Object.freeze(o),Object.freeze(o.prototype),this.Jukebox=o,r.defaults={skin:"default",rootClass:"jukebox",skinParams:{dragdrop:!0,playQueueNode:"ul",songNode:"li"}},r.skins={},Object.freeze(r),Object.freeze(r.prototype)}();